const e=[],t=()=>e.forEach((e=>e())),r=e=>{history.replaceState(null,null,e?`#${encodeURIComponent(e)}`:"#"),t()};window.addEventListener("DOMContentLoaded",t),window.addEventListener("popstate",t);let n=null,l=Date.now(),a=null;const o=(e,t=!1)=>fetch(`https://eigencors.deno.dev/${e}`).then((e=>{if(!e.ok)throw new Error(e.status);return t?e.text():e.json()})),s=()=>!n||Date.now()-l>3e5?o("https://xkcd.com/info.0.json").then((e=>(n=e,l=Date.now(),e))):Promise.resolve(n),i=e=>s().then((({num:t})=>{const r=parseInt(e);return!isNaN(r)&&r>=1&&r<=t?e:"random"===e?Math.floor(Math.random()*t+1).toString():""})),c=document.querySelector("[data-strip-placeholder]"),d=document.querySelector("[data-strip-placeholder-message]"),p=document.querySelector(".strip"),u=p.querySelector("[data-strip-view-toggle]"),h=p.querySelector("[data-strip-image]"),m=p.querySelector("[data-strip-transcript]"),g=p.querySelector("[data-strip-number]"),y=p.querySelector("[data-strip-title]"),v=p.querySelector("[data-strip-date]"),S=p.querySelector("[data-strip-alt-text]"),L=p.querySelector("[data-strip-source-link]"),f=p.querySelector("[data-strip-explain-link]"),w=(e,t)=>{if(e)return c.style.display=null,p.style.display="none","404"===e.message?(c.classList.remove("strip-placeholder--loading"),c.classList.add("strip-placeholder--404"),void(d.textContent="Not Found")):(c.classList.remove("strip-placeholder--loading"),c.classList.add("strip-placeholder--error"),void(d.textContent="Error loading strip data"));c.style.display="none",p.style.display=null;const r=new Image;if(r.src=t.img,h.innerHTML="",t.link){const e=document.createElement("a");e.href=t.link,e.target="blank",e.appendChild(r),h.appendChild(e)}else h.appendChild(r);var n;m.innerHTML=(n=t.transcript)?n.replace(/{{[^{]*?([aA]lt|[tT]itle)[\ -]?([tT]ext)*:[^}]*?}}/,"").trim().replaceAll(/(?<!\<)\<(?!\<)/g,"&lt;").replaceAll(/(?<!\>)\>(?!\>)/g,"&gt;").replaceAll(/\<\<([\w\W]*?)\>\>/g,"<code>$1</code>").replaceAll(/\[\[([\w\W]*?)\]\]/g,"<strong>$1</strong>").replaceAll(/\(\(([\w\W]*?)\)\)/g,"<em>$1</em>").replaceAll(/\{\{([\w\W]*?)\}\}/g,"<em><strong>$1</strong></em>").split("\n\n").map((e=>`<p>${e.replaceAll("\n","<br>")}</p>`)).join(""):"<em>No transcript available</em>",g.textContent=`#${t.num}:`,y.innerHTML=`${t.title}`,document.title=`${t.num}: ${t.title} - xkcd viewer`;const{year:l,month:a,day:o}=t,s=new Date(l,a-1,o);v.textContent=`Posted on ${s.toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})}`,S.textContent=t.alt,L.href=`https://xkcd.com/${t.num}`,f.href=`https://www.explainxkcd.com/wiki/index.php/${t.num}`};u.addEventListener("click",(()=>{h.classList.toggle("visually-hidden"),m.classList.toggle("visually-hidden"),u.classList.toggle("toggle-btn--image"),u.classList.toggle("toggle-btn--transcript")}));const q=document.querySelector(".navigation"),x=q.querySelector("[data-navlink-first]"),k=q.querySelector("[data-navlink-prev]"),$=q.querySelector("[data-navlink-next]"),C=q.querySelector("[data-navlink-latest]"),b=document.querySelector(".search"),A=document.querySelector(".search__input"),_=document.querySelector(".search__results");let E=!1;const D=()=>{_.innerHTML="",b.classList.add("search--idle")};b.classList.add("search--idle"),A.addEventListener("input",(e=>{D();e.target.value&&!E&&(E=!0,(a?Promise.resolve(a.slice()):o("https://xkcd.com/archive/",!0).then((e=>{const t=(new DOMParser).parseFromString(e,"text/html"),r=Array.from(t.links).filter((e=>e.pathname.match(/^\/[0-9]+\/$/)&&"Invalid Date"!==new Date(e.title).toString())).map((e=>({number:e.pathname.slice(1,e.pathname.length-1),date:new Date(e.title),title:e.textContent})));return a=r,r}))).then((e=>{E=!1;let t=e.filter((e=>e.title.toLowerCase().includes(A.value.toLowerCase()))).slice(0,20);console.log(t),t.forEach((e=>{const t=document.querySelector("#search_result_template").content.cloneNode(!0),r=t.querySelector(".search__link"),n=t.querySelector(".search__result-number"),l=t.querySelector(".search__result-text");r.href=`#${e.number}`,n.textContent=`#${e.number}`,l.textContent=e.title,r.addEventListener("click",(()=>{D()})),_.appendChild(t)})),t.length&&b.classList.remove("search--idle")})))})),document.addEventListener("focusout",(e=>{b.contains(e.relatedTarget)||D()})),(t=>{const r=()=>{const e=location.hash.slice(1)||"";t(e)};e.push(r)})((e=>{c.style.display=null,p.style.display="none",c.classList.add("strip-placeholder--loading"),c.classList.remove("strip-placeholder--error"),c.classList.remove("strip-placeholder--404"),d.textContent="Loading...",i(e).then((t=>{if(e!==t)return r(t);var n;s().then((e=>{const r=e.num;var n,l;displayedNum=parseInt(t)||r,n=displayedNum,l=r,1===n?(k.removeAttribute("href"),x.removeAttribute("href")):(k.href="#"+(n-1),x.href="#1"),n===l?($.removeAttribute("href"),C.removeAttribute("href")):($.href=`#${n+1}`,C.href="#")})),(n=t,n?o(`https://xkcd.com/${n}/info.0.json`):s()).then((e=>{w(null,e)})).catch((e=>{w(e,null)}))}))}));